var b=class{_initialized=!1;_connector;_client;Devices={Viberators:[],Vorze_SA:[]};constructor(){console.log("buttplugOperator constructed.")}ParseDeviceList(){this.Devices.Vorze_SA.splice(0),this.Devices.Viberators.splice(0),this._client.Devices.forEach(e=>{e.Name==="Vorze UFO SA"?(this.Devices.Vorze_SA.push(e),e.rotate(.4,!0),setTimeout(()=>{e.stop()},600)):e.AllowedMessages.includes(Buttplug.ButtplugDeviceMessageType.VibrateCmd)&&(this.Devices.Viberators.push(e),e.vibrate(.5),setTimeout(()=>{e.stop()},600))}),console.log("Viberators:"),this.Devices.Viberators.forEach(e=>{console.log("  "+e.Name)}),console.log("Vorze_SA:"),this.Devices.Vorze_SA.forEach(e=>{console.log("  "+e.Name)})}SendViberateMsg(e){this.Devices.Viberators.forEach(i=>{i.vibrate(e)})}SendRotateMsg(e,i){this.Devices.Vorze_SA.forEach(o=>{o.rotate(e,i)})}async Initialize(){this._initialized||await Buttplug.buttplugInit(),this._connector=new Buttplug.ButtplugEmbeddedConnectorOptions,this._client=new Buttplug.ButtplugClient,this._client.addListener("deviceadded",e=>{console.log(`device added: ${e.Name}`),this.ParseDeviceList()}),this._client.addListener("deviceremoved",async e=>{console.log(`device removed: ${e.Name}`),this.ParseDeviceList()}),console.log("buttplugOperator try connect..."),await this._client.connect(this._connector),this._initialized=!0,console.log("buttplugOperator Initialized.")}async ConnectDevice(){this._client&&this._connector?await this._client.startScanning():console.log("buttplugOperator connector missing.")}};var v;(M=>{class t{Milliseconds=0;Power=0;constructor(s,r){this.Milliseconds=s,r<0?this.Power=0:r>1e3?this.Power=1e3:this.Power=r}get ButtPower(){return this.Power/1e3}get Seconds(){return Math.trunc(this.Milliseconds/1e3)}get HHMMSS(){let s=Math.floor(this.Milliseconds/1e3),r=Math.floor(s/60),n=Math.floor(r/60),l=String(s%60).padStart(2,"0"),u=String(r%60).padStart(2,"0");return`${String(n).padStart(2,"0")}:${u}:${l}`}toString(){return`Time: ${this.Milliseconds}, Power: ${this.ButtPower}`}}M.ScriptLine=t;let e=/^([0-9]+)(\.[0-9]{1,2})?,(1000|[0-9]+)$/;function i(a){let r=a.replace(/\r\n|\r/g,`
`).split(/\n/);r.slice(-1)[0]===""&&r.pop();let n=!0;for(let l=0;l<r.length;l++)if(!r[l].match(e)){n=!1;break}return n}M.Validate=i;function o(a){let r=a.replace(/\r\n|\r/g,`
`).split(/\n/),n=[];return r.forEach(l=>{let u=l.match(e);if(u){let S=Number(u[1])*1e3;if(u[2]){let f=u[2].replace(".",""),V;f.length==1?V=Number(f)*10:V=Number(f),S+=V*10}let D=Number(u[3]),y=new t(S,D);n.push(y)}}),console.log("script start time: "+n[0].HHMMSS),n}function c(a){let s=[];return a.forEach(n=>{let l=n.Seconds;s[l]===void 0&&(s[l]=[]),s[l].push(n)}),s}function m(a){let s=o(a);return c(s)}M.LoadScript=m;let d=[new t(500,800),new t(600,0),new t(1500,400),new t(1600,0),new t(2500,800),new t(2600,0),new t(3500,400),new t(3600,0),new t(4500,800),new t(4600,0),new t(5500,400),new t(5600,0),new t(6500,800),new t(6600,0),new t(7500,400),new t(7600,0)];M.TestScript=c(d)})(v||={});var w;(M=>{class t{Milliseconds=0;Clockwise=!0;Power=0;get ButtPower(){return this.Power/100}get Seconds(){return Math.trunc(this.Milliseconds/1e3)}get HHMMSS(){let s=Math.floor(this.Milliseconds/1e3),r=Math.floor(s/60),n=Math.floor(r/60),l=String(s%60).padStart(2,"0"),u=String(r%60).padStart(2,"0");return`${String(n).padStart(2,"0")}:${u}:${l}`}constructor(s,r,n){this.Milliseconds=s,this.Clockwise=r,n<0?this.Power=0:n>100?this.Power=100:this.Power=n}toString(){return`Time: ${this.Milliseconds}, Clockwise: ${this.Clockwise} Power: ${this.ButtPower}`}}M.ScriptLine=t;let e=/^([0-9]+),(0|1),(100|[0-9]{1,2})$/;function i(a){let r=a.replace(/\r\n|\r/g,`
`).split(/\n/);r.slice(-1)[0]===""&&r.pop();let n=!0;for(let l=0;l<r.length;l++)if(!r[l].match(e)){n=!1;break}return n}M.Validate=i;function o(a){let r=a.replace(/\r\n|\r/g,`
`).split(/\n/),n=[];return r.forEach(l=>{let u=l.match(e);if(u){let S=Number(u[1])*100,D=u[2]==="1",y=Number(u[3]),f=new t(S,D,y);n.push(f)}}),console.log("script start time: "+n[0].HHMMSS),n}function c(a){let s=[];return a.forEach(n=>{let l=n.Seconds;s[l]===void 0&&(s[l]=[]),s[l].push(n)}),s}function m(a){let s=o(a);return c(s)}M.LoadScript=m;let d=[new t(500,!0,800),new t(600,!0,0),new t(1500,!1,400),new t(1600,!1,0),new t(2500,!0,800),new t(2600,!0,0),new t(3500,!1,400),new t(3600,!1,0),new t(4500,!0,800),new t(4600,!0,0),new t(5500,!1,400),new t(5600,!1,0),new t(6500,!0,800),new t(6600,!0,0),new t(7500,!1,400),new t(7600,!1,0)];M.TestScript=c(d)})(w||={});var E=class{_buttplugOperator;_previousSeconds=0;_timerIDs=new Set;Offset=0;Scripts={Viberator:void 0,UFOSA:void 0};constructor(e){this._buttplugOperator=e}GetFileName(e){return e.match(/[a-zA-Z]:\\/)?e.split("\\").reverse()[0]:e.split("/").reverse()[0]}LoadScript(e,i){if(v.Validate(e)){let o=v.LoadScript(e);return this.Scripts.Viberator={Script:o,Name:this.GetFileName(i)},console.log("timeroter script loaded. lines: "+o.length),!0}else if(w.Validate(e)){let o=w.LoadScript(e);return this.Scripts.UFOSA={Script:o,Name:this.GetFileName(i)},console.log("Vorze_SA script loaded. lines: "+o.length),!0}else return!1}Play(e){let i=Math.trunc(e);this._previousSeconds=i-2,this.OperateViberatorScript(i-1),this.OperateSAScript(i-1),this._previousSeconds=i}Stop(){this._previousSeconds=0,this._buttplugOperator.Devices.Viberators.forEach(e=>{e.stop()}),this._buttplugOperator.Devices.Vorze_SA.forEach(e=>{e.stop()}),this._timerIDs.forEach(e=>{clearTimeout(e)}),this._timerIDs.clear()}TimeUpdate(e){let i=e+this.Offset,o=Math.trunc(i);o!==this._previousSeconds&&(this.OperateViberatorScript(i),this.OperateSAScript(i),this._previousSeconds=o)}OperateSAScript(e){if(!this.Scripts.UFOSA)return;let i=Math.trunc(e),o=this.Scripts.UFOSA.Script;this._buttplugOperator.Devices.Vorze_SA.length>0&&i!==this._previousSeconds&&o[i+1]&&o[i+1].forEach(c=>{let m=c.Milliseconds-Math.trunc(e*1e3);setTimeout(()=>console.log(c.toString()),m);let d=window.setTimeout(()=>{this._buttplugOperator.SendRotateMsg(c.ButtPower,c.Clockwise)},m);this._timerIDs.add(d),setTimeout(()=>{this._timerIDs.delete(d)},3e3)})}OperateViberatorScript(e){if(!this.Scripts.Viberator)return;let i=Math.trunc(e),o=this.Scripts.Viberator.Script;this._buttplugOperator.Devices.Viberators.length>0&&i!==this._previousSeconds&&o[i+1]&&o[i+1].forEach(c=>{let m=c.Milliseconds-Math.trunc(e*1e3);setTimeout(()=>console.log(c.toString()),m);let d=window.setTimeout(()=>{this._buttplugOperator.SendViberateMsg(c.ButtPower)},m);this._timerIDs.add(d),setTimeout(()=>{this._timerIDs.delete(d)},3e3)})}};var O=class{Elem;constructor(e){this.Elem=e}AppendToList(e,i){let o=document.createElement("li");o.innerText=i,e.appendChild(o)}AppendVibDeviceList(e){this.AppendToList(this.Elem.VibDeviceList,e)}AppendUFOSADeviceList(e){this.AppendToList(this.Elem.UFOSADeviceList,e)}AppendVibScriptList(e){this.AppendToList(this.Elem.VibScriptList,e)}AppendUFOSAScriptList(e){this.AppendToList(this.Elem.UFOSAScriptList,e)}ClearDeviceLists(){for(;this.Elem.VibDeviceList.childNodes[0];)this.Elem.VibDeviceList.removeChild(this.Elem.VibDeviceList.childNodes[0]);for(;this.Elem.UFOSADeviceList.childNodes[0];)this.Elem.UFOSADeviceList.removeChild(this.Elem.UFOSADeviceList.childNodes[0])}ClearScriptLists(){for(;this.Elem.VibScriptList.childNodes[0];)this.Elem.VibScriptList.removeChild(this.Elem.VibScriptList.childNodes[0]);for(;this.Elem.UFOSAScriptList.childNodes[0];)this.Elem.UFOSAScriptList.removeChild(this.Elem.UFOSAScriptList.childNodes[0])}};var A={Player:document.getElementById("player"),VibDeviceList:document.getElementById("VibDeviceList"),UFOSADeviceList:document.getElementById("UFOSADeviceList"),VibScriptList:document.getElementById("VibScriptList"),UFOSAScriptList:document.getElementById("UFOSAScriptList")},p=new O(A),L=new b,g=new E(L);function B(){p.ClearDeviceLists();for(let t of L.Devices.Viberators)p.AppendVibDeviceList(t.Name);for(let t of L.Devices.Vorze_SA)p.AppendUFOSADeviceList(t.Name)}function _(){p.ClearScriptLists();let t=g.Scripts.Viberator,e=g.Scripts.UFOSA;t&&p.AppendVibScriptList(t.Name),e&&p.AppendUFOSAScriptList(e.Name)}function T(){console.log("addEvent() called."),p.Elem.Player.addEventListener("timeupdate",()=>{p.Elem.Player.paused||g.TimeUpdate(p.Elem.Player.currentTime)});function t(c){g.Stop()}p.Elem.Player.addEventListener("pause",t),p.Elem.Player.addEventListener("ended",t);let e=document.getElementById("scriptInput");e.addEventListener("input",c=>{let m=e.files[0],d=e.value;if(m!=null){let h=new FileReader;h.readAsText(m),h.onload=function(){h.result&&g.LoadScript(h.result,d)&&_()},h.onerror=function(){console.log(h.error)}}}),document.getElementById("scriptButton").addEventListener("click",c=>{e?.click()});let i=document.getElementById("mediaInput");i.addEventListener("input",()=>{let c=i.files;c&&(c[0].type.startsWith("video/")?(p.Elem.Player.src=URL.createObjectURL(c[0]),p.Elem.Player.style.height="auto"):c[0].type.startsWith("audio/")&&(p.Elem.Player.src=URL.createObjectURL(c[0]),p.Elem.Player.style.height="3em")),i.files=null}),document.getElementById("mediaButton")?.addEventListener("click",()=>{i.click()});let o=document.getElementById("offset");o?.addEventListener("change",c=>{g.Offset=Number(o.value)}),document.getElementById("connectButton").addEventListener("click",async()=>{await L.ConnectDevice(),B()})}async function C(){console.log("main loaded."),T(),L.Initialize()}window.onload=C;
